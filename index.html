<!DOCTYPE html>
<html lang="en" class="min-h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mars Live News: ISS Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

        body {
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2b2b2b 50%, #4a2e2e 100%),
                        url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJub25lIi8+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iMiIgZmlsbD0iI2ZmNjYwMCIgb3BhY2l0eT0iMC4xIi8+PGNpcmNsZSBjeD0iMjAiIGN5PSI2MCIgcj0iMSIgZmlsbD0iI2ZmZiIgb3BhY2l0eT0iMC4wNSIvPjxjaXJjbGUgY3g9IjgwIiBjeT0iODAiIHI9IjEuNSIgZmlsbD0iI2ZmZiIgb3BhY2l0eT0iMC4wNyIvPjwvc3ZnPg==') repeat;
            background-blend-mode: overlay;
            background-attachment: fixed;
            color: #d1d1d1;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .starcraft-panel {
            @apply bg-gradient-to-br from-gray-900/90 to-black/90 backdrop-blur-md shadow-2xl shadow-orange-600/20;
        }
        .left-align-text {
            @apply text-left;
        }
        #fact-container, #apod-container, #mission-countdown {
            @apply bg-gradient-to-b from-gray-900/95 via-black/95 to-gray-900/95 backdrop-blur-md flex flex-col items-center text-center p-6 rounded-xl relative overflow-hidden border border-orange-900/40 shadow-2xl shadow-orange-600/30;
        }
        #fact-text {
            @apply text-gray-200 text-xl md:text-2xl font-medium tracking-wide shadow-[0_0_12px_rgba(255,102,0,0.8)] relative z-10;
        }
        #countdown {
            color: #10b981;
            margin-top: 1.5rem;
            @apply text-base md:text-lg font-mono relative z-10;
        }
        #mission-countdown-text {
            @apply text-orange-400 text-base md:text-lg mt-4 font-mono relative z-10;
        }
        #apod-image {
            @apply w-full h-64 md:h-80 object-cover rounded-lg mb-4 shadow-xl transition-transform duration-500 relative z-10 border border-orange-800/50 hover:scale-105;
        }
        #apod-title {
            @apply text-gray-200 text-xl md:text-2xl font-bold mb-2 tracking-tight relative z-10;
        }
        #apod-explanation {
            @apply text-gray-400 text-base md:text-lg leading-relaxed relative z-10;
        }
        #mission-countdown-timer {
            color: #f97316;
            @apply text-3xl md:text-4xl font-bold mt-4 relative z-10 shadow-[0_0_8px_rgba(255,102,0,0.6)];
        }
        #mission-countdown-qr {
            @apply mt-6 w-40 h-40 md:w-48 md:h-48 object-contain rounded-md shadow-md border border-orange-800/50 relative z-10;
        }
        #mars-weather-widget {
            @apply flex items-center space-x-2 text-gray-200 text-base md:text-lg p-2 rounded-lg relative overflow-hidden;
            transition: background 1s ease;
        }
        #mars-weather-widget.cold {
            background: linear-gradient(45deg, #2e4a6b, #1a2e4a);
        }
        #mars-weather-widget.hot {
            background: linear-gradient(45deg, #d14d2f, #ff4d2f);
        }
        #mars-weather-widget::before {
            content: '';
            @apply absolute inset-0 opacity-20 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1IiBoZWlnaHQ9IjUiPjxwYXR0ZXJuIGlkPSJhIiB3aWR0aD0iNSIgaGVpZ2h0PSI1Ij48Y2lyY2xlIGN4PSIyLjUiIGN5PSI2LjUiIHI9IjAuNSIgZmlsbD0iI2ZmNjYwMCIvPjwvcGF0dGVybj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI2EpIi8+PC9zdmc+')] pointer-events-none;
        }
        #distance-display {
            @apply mt-6 w-full h-16 flex items-center justify-center text-gray-200 text-base md:text-lg relative;
        }
        #map-footer {
            position: relative;
            height: 400px;
            width: 100%;
        }
        #iss-title {
            color: #10b981;
            @apply text-base md:text-lg font-mono relative z-10;
        }
        .iss-trail {
            display: none;
        }
        .animate-spin-slow {
            animation: spin 20s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .map-overlay {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 6px 10px;
            border-radius: 4px;
            color: #fff;
            font-size: 12px;
            z-index: 1000;
        }
        .video-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            z-index: 2000;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(255, 102, 0, 0.8);
            display: none;
        }
        .data-section {
            @apply pb-2 border-b border-gray-800/50 relative;
            animation: pulse-border 3s infinite;
        }
        @keyframes pulse-border {
            0%, 100% { border-color: rgba(251, 146, 60, 0.5); }
            50% { border-color: rgba(251, 146, 60, 0.9); }
        }
        .data-title {
            @apply text-base md:text-lg font-bold uppercase text-orange-500 tracking-wider flex items-center;
        }
        .data-value {
            @apply mt-1 text-xl md:text-2xl font-mono text-gray-200 left-align-text;
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .data-timestamp {
            display: none;
        }
        .refresh-dot {
            @apply w-2 h-2 md:w-3 md:h-3 bg-green-500 rounded-full ml-2 animate-ping;
        }
        .glitch {
            position: relative;
            color: #ff6600;
            animation: glitch 1s linear infinite;
        }
        @keyframes glitch {
            2%, 64% { transform: translate(1px, 0); }
            4%, 60% { transform: translate(-1px, 0); }
            62% { transform: translate(0, 1px); }
            0%, 66%, 100% { transform: translate(0, 0); }
        }
        .starfield {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJub25lIi8+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iMS41IiBmaWxsPSIjZmZmIiBvcGFjaXR5PSIwLjEiLz48Y2lyY2xlIGN4PSI2MCIgY3k9IjMwIiByPSIxIiBmaWxsPSIjZmZmIiBvcGFjaXR5PSIwLjA4Ii8+PGNpcmNsZSBjeD0iMjAiIGN5PSI3MCIgcj0iMC43IiBmaWxsPSIjZmZmIiBvcGFjaXR5PSIwLjA2Ii8+PC9zdmc+') repeat;
            opacity: 0.15;
            animation: twinkle 5s infinite;
            pointer-events: none;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.15; }
            50% { opacity: 0.25; }
        }
        .logo-container {
            @apply flex justify-center items-center w-full mt-6;
        }
        .logo {
            @apply max-w-full h-auto;
            max-height: 250px;
            width: auto;
            filter: drop-shadow(0 0 12px rgba(255, 102, 0, 0.5));
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .location-icon {
            width: 48px;
            height: 48px;
            box-shadow: 0 0 8px rgba(255, 102, 0, 0.5);
        }
        #position {
            @apply flex flex-row-reverse items-center text-2xl md:text-3xl font-bold text-gray-100 tracking-wide;
        }

        .news-ticker {
            @apply fixed bottom-0 left-0 w-full text-lg md:text-xl font-mono h-20 md:h-24 overflow-hidden z-50;
            color: #10b981;
            background: linear-gradient(to right, rgba(17, 24, 39, 0.95), rgba(0, 0, 0, 0.95)), url("earthcard.jpg");
            background-size: cover;
            background-position: center;
            border-top: 1px solid rgba(251, 146, 60, 0.6);
            box-shadow: 0 -4px 15px rgba(255, 102, 0, 0.3);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
        }
        .ticker-content {
            display: inline-block;
            white-space: nowrap;
            padding-left: 100%;
            animation: ticker 40s linear infinite;
            text-shadow: 0 0 8px rgba(16, 185, 129, 0.7);
            position: relative;
            z-index: 10;
        }
        .ticker-content:hover {
            animation-play-state: paused;
        }
        @keyframes ticker {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        /* Responsive Adjustments */
        @media (min-width: 1920px) {
            body {
                height: 1080px;
                width: 1920px;
            }
            .flex.min-h-screen {
                height: 1080px;
                padding-bottom: 96px; /* Matches ticker height at 1920px */
            }
            #map-footer {
                height: 500px;
            }
            .starcraft-panel {
                padding: 2rem;
            }
            .data-title {
                @apply text-xl;
            }
            .data-value {
                @apply text-3xl;
            }
            #fact-text, #apod-title {
                @apply text-3xl;
            }
            #apod-explanation, #countdown, #mission-countdown-text {
                @apply text-xl;
            }
            #mission-countdown-timer {
                @apply text-5xl;
            }
            #mission-countdown-qr {
                @apply w-56 h-56;
            }
            .logo {
                max-height: 300px;
            }
            .location-icon {
                width: 64px;
                height: 64px;
            }
            #position {
                @apply text-4xl;
            }
            .news-ticker {
                @apply text-2xl h-24;
            }
            .map-overlay {
                font-size: 16px;
                padding: 8px 12px;
            }
        }

        @media (max-width: 1280px) {
            .flex.min-h-screen {
                padding-bottom: 80px; /* Matches ticker height */
            }
            #map-footer {
                height: 300px;
            }
            .starcraft-panel {
                padding: 1rem;
            }
            #mission-countdown-qr {
                @apply w-32 h-32;
            }
            .logo {
                max-height: 200px;
            }
            .news-ticker {
                @apply h-20;
            }
        }

        @media (max-width: 768px) {
            .flex.min-h-screen {
                @apply flex-col;
                padding-bottom: 64px; /* Matches ticker height */
            }
            .starcraft-panel {
                @apply w-full;
            }
            #map-footer {
                height: 250px;
            }
            .news-ticker {
                @apply text-base h-16;
            }
        }
    </style>
</head>
<body class="min-h-screen text-gray-100">
    <div class="flex min-h-screen flex-col">
        <div class="w-full grow flex flex-col lg:flex-row gap-6 p-4 lg:p-8">
            <!-- Left Sidebar: Map and Data -->
            <div class="starcraft-panel bg-gradient-to-br from-gray-900/90 to-black/90 px-6 py-8 lg:w-96 lg:shrink-0 lg:pl-10 lg:pr-8 rounded-xl">
                <div class="grid grid-cols-1 gap-6">
                    <div id="map-footer" class="h-72 w-full rounded-xl bg-gradient-to-br from-gray-900/90 to-black/90 border border-orange-900/50 shadow-2xl shadow-orange-600/30 relative">
                        <div id="live-indicator" class="absolute top-3 right-3 w-4 h-4 bg-green-500 rounded-full animate-ping z-[1000]"></div>
                        <div id="map-overlay" class="map-overlay">ISS Speed: Loading... | Altitude: Loading...</div>
                        <iframe id="iss-video" class="video-overlay" src="https://www.youtube.com/embed/H999s0P1Er0?autoplay=1&loop=1" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                    </div>
                    <div class="p-6 relative overflow-hidden">
                        <div class="starfield"></div>
                        <div class="grid grid-cols-1 gap-4 relative z-10">
                            <div class="data-section" id="iss-section">
                                <p class="data-title" id="iss-title">ISS Current Location</p>
                                <br>
                                <p class="data-title hidden">
                                    <svg class="mr-2 h-5 w-5 text-orange-500" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2a10 10 0 00-9.9 8.6L6 12l-3.9 1.4A10 10 0 1012 2zm0 16a6 6 0 110-12 6 6 0 010 12z"/></svg>
                                    ISS Position
                                </p>
                                <p class="data-value" id="position">Loading...</p>
                            </div>
                            <div class="data-section" id="weather-section">
                                <p class="data-title">Mars Weather</p>
                                <div id="mars-weather-widget" class="left-align-text">
                                    <span id="mars-weather" class="data-value">Loading...</span>
                                </div>
                            </div>
                            <div class="data-section" id="sol-section">
                                <p class="data-title">Mars Sol Date</p>
                                <p class="data-value" id="mars-sol-date">Loading...</p>
                            </div>
                            <div class="data-section" id="distance-section">
                                <p class="data-title">Earth-Mars Distance</p>
                                <p class="data-value" id="earth-mars-distance">Loading...</p>
                            </div>
                        </div>
                    </div>
                    <div class="logo-container mt-6">
                        <img src="logomarslivenewsv1.png" alt="My Logo" class="logo">
                    </div>
                </div>
            </div>

            <!-- Middle: Mars News -->
            <div class="starcraft-panel bg-gradient-to-br from-gray-900/90 to-black/90 px-6 py-8 lg:flex-1 lg:px-10 rounded-xl">
                <div class="rounded-xl p-6 h-full">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-200 mb-6 flex items-center tracking-tight">
                        <svg class="mr-3 h-6 w-6 md:h-8 md:w-8 text-orange-500" viewBox="0 0 512 512" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M256 0C114.6 0 0 114.6 0 256c0 141.4 114.6 256 256 256s256-114.6 256-256C512 114.6 397.4 0 256 0zM382.7 321c-14.36 27.37-35.93 50.22-61.93 65.74c-26.01 15.52-56.02 23.88-87.43 23.88c-31.42 0-61.42-8.357-87.43-23.88c-26-15.52-47.57-38.37-61.93-65.74l-40.29 21.15c18.01 34.31 45.08 62.99 77.72 82.47c32.65 19.48 70.31 29.95 109.2 29.95c38.9 0 76.56-9.467 109.2-29.95c32.65-19.48 59.72-48.16 77.72-82.47L382.7 321zM256 256c-61.86 0-112-50.14-112-112S194.1 32 256 32s112 50.14 112 112S317.9 256 256 256z"/></svg>
                        Mars News
                    </h2>
                    <div id="mars-news-container" class="grid gap-6"></div>
                    <div id="distance-display"></div>
                </div>
            </div>

            <!-- Right Sidebar: Did You Know? + APOD + Mission Countdown -->
            <div class="starcraft-panel bg-gradient-to-br from-gray-900/90 to-black/90 px-6 py-8 lg:w-96 lg:shrink-0 lg:pr-10 lg:pl-8 rounded-xl">
                <div class="rounded-xl h-full flex flex-col gap-6 p-4">
                    <div id="fact-container" class="flex-1">
                        <h3 class="text-xl md:text-2xl font-bold text-gray-200 mb-4 flex items-center tracking-tight relative z-10">
                            <svg class="mr-3 h-6 w-6 md:h-8 md:w-8 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Did You Know?
                        </h3>
                        <div id="fact-text">Loading fact...</div>
                        <div id="countdown"></div>
                    </div>
                    <div id="apod-container" class="flex-1">
                        <img id="apod-image" src="https://via.placeholder.com/300x200?text=Loading+APOD" alt="APOD Image">
                        <div id="apod-title">Loading...</div>
                        <div id="apod-explanation">Loading...</div>
                    </div>
                    <div id="mission-countdown" class="flex-1">
                        <h3 class="text-xl md:text-2xl font-bold text-gray-200 mb-4 tracking-tight relative z-10">Mars Mission Countdown</h3>
                        <div id="mission-countdown-timer">Loading...</div>
                        <div id="mission-countdown-text">Next Launch: Starship Mars 2026</div>
                        <img id="mission-countdown-qr" src="bmc_qr.png" alt="Support QR Code">
                    </div>
                </div>
            </div>
        </div>

        <div class="news-ticker">
            <div class="ticker-content">
                Hi, I'm Cristian, a space enthusiast and developer passionate about Mars exploration and Space! --- This is the Alpha Version of the Mars Live News APP --- Stay tuned for more updates and features! Don't forget to like and subscribe!
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof L === 'undefined') {
                console.error('Leaflet.js failed to load from CDN');
                document.getElementById('position').innerText = 'Leaflet.js not loaded';
                return;
            }

            const map = L.map('map-footer', {
                zoomControl: false,
                attributionControl: false,
                minZoom: 2,
                maxZoom: 8,
                maxBounds: [[-90, -180], [90, 180]],
                maxBoundsViscosity: 1.0,
                worldCopyJump: true,
                doubleClickZoom: false,
                dragging: false,
                scrollWheelZoom: false
            }).setView([0, 0], 3);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 8,
                opacity: 0.95,
                attribution: ''
            }).addTo(map);

            L.tileLayer('https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=2e6aead3e377b566eb9b6dbf4472a0ba', {
                maxZoom: 8,
                opacity: 0.3,
                attribution: ''
            }).addTo(map);

            const issIcon = L.divIcon({
                html: `<div class="relative animate-spin-slow"><img src="https://www.svgrepo.com/show/440494/international-space-station.svg" class="w-12 h-12 md:w-16 md:h-16" style="filter: drop-shadow(0 0 8px rgba(255, 102, 0, 0.9));"></div>`,
                iconSize: [64, 64],
                iconAnchor: [32, 32],
                className: ''
            });
            const issMarker = L.marker([0, 0], { icon: issIcon, zIndexOffset: 1000 }).addTo(map);
            const issPath = L.polyline([], { className: 'iss-trail' }).addTo(map);
            const issPositions = [];

            function autoAdjustMap(lat, lon) {
                const zoomLevels = [3, 4, 5];
                const newZoom = zoomLevels[Math.floor(Math.random() * zoomLevels.length)];
                map.flyTo([lat, lon], newZoom, { duration: 5 });
            }

            window.addEventListener('load', () => {
                setTimeout(() => map.invalidateSize(), 500);
            });

            const nasaApiKey = '139tA67S54x5fGKtqBaJFFFvimSZxaVT2Gtov5fk';
            const factsApiKey = 'F5SXDJ/3FE9Ekwdb8A3UBw==8PfT6BN4r3CTkYGe';
            const openCageApiKey = '96f1ffed02714592b97cd34d09b29486';
            const oceanIcon = `<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a7/Atlantic_near_Faroe_Islands.jpg/1200px-Atlantic_near_Faroe_Islands.jpg" class="location-icon" alt="Ocean">`;

            let lastLat = 0, lastLon = 0, lastTimestamp = 0;
            let locationCache = {};
            let lastApiCallTime = 0;

            function getFlagIcon(countryCode) {
                if (!countryCode || countryCode.length !== 2) return oceanIcon;
                return `<img src="https://flagcdn.com/48x36/${countryCode.toLowerCase()}.png" class="location-icon" alt="${countryCode} Flag">`;
            }

            function getOceanFromCoordinates(lat, lon) {
                if (lat >= -60 && lat <= -10 && lon >= 70 && lon <= 155) return "Indian Ocean";
                if (lat >= -50 && lat <= 50 && (lon >= -180 && lon <= -70 || lon >= 150 && lon <= 180)) return "Pacific Ocean";
                if (lat >= -50 && lat <= 60 && lon >= -70 && lon <= 20) return "Atlantic Ocean";
                if (lat >= 60 && lon >= -180 && lon <= 180) return "Arctic Ocean";
                if (lat <= -60 && lon >= -180 && lon <= 180) return "Southern Ocean";
                return null;
            }

            function getCountryFromCoordinates(lat, lon) {
                if (lat >= 40 && lat <= 83 && lon >= -141 && lon <= -52) return { name: "Canada", code: "ca" };
                if (lat >= 24 && lat <= 50 && lon >= -125 && lon <= -66) return { name: "United States", code: "us" };
                if (lat >= -56 && lat <= 13 && lon >= -81 && lon <= -34) return { name: "Brazil", code: "br" };
                if (lat >= -50 && lat <= -12 && lon >= 112 && lon <= 155) return { name: "Australia", code: "au" };
                if (lat >= 36 && lat <= 71 && lon >= -10 && lon <= 40) return { name: "Russia", code: "ru" };
                if (lat >= 35 && lat <= 70 && lon >= 40 && lon <= 180) return { name: "Russia", code: "ru" };
                if (lat >= -35 && lat <= 5 && lon >= 10 && lon <= 25) return { name: "South Africa", code: "za" };
                if (lat >= 35 && lat <= 60 && lon >= 73 && lon <= 135) return { name: "China", code: "cn" };
                if (lat >= 36 && lat <= 71 && lon >= -25 && lon <= 60) return { name: "European Union", code: "eu" };
                return { name: "Unknown Location", code: null };
            }

            async function getLocationWithIcon(lat, lon) {
                const key = `${lat.toFixed(0)},${lon.toFixed(0)}`;
                if (locationCache[key]) return locationCache[key];

                const now = Date.now();
                if (now - lastApiCallTime < 35000) {
                    return locationCache[key] || determineLocation(lat, lon);
                }

                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    const response = await fetch(`https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lon}&key=${openCageApiKey}&limit=1`, {
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();

                    if (!data.results || data.results.length === 0) throw new Error('No results from OpenCage');

                    const result = data.results[0];
                    const components = result.components;
                    let name, icon;

                    if (components.ocean) {
                        name = `${components.ocean} Ocean`;
                        icon = oceanIcon;
                    } else if (components.country) {
                        name = components.country;
                        if (components.state) {
                            name = `${components.country}, ${components.state}`;
                        } else if (components.region) {
                            name = `${components.country}, ${components.region}`;
                        }
                        icon = getFlagIcon(components.country_code);
                    } else {
                        name = getOceanFromCoordinates(lat, lon) || "Unknown Location";
                        icon = oceanIcon;
                    }

                    const location = { name, icon };
                    locationCache[key] = location;
                    lastApiCallTime = now;
                    return location;
                } catch (error) {
                    console.warn('OpenCage Geocoding Error:', error.message);
                    return determineLocation(lat, lon);
                }
            }

            function determineLocation(lat, lon) {
                const ocean = getOceanFromCoordinates(lat, lon);
                if (ocean) return { name: ocean, icon: oceanIcon };
                const country = getCountryFromCoordinates(lat, lon);
                return { name: country.name, icon: getFlagIcon(country.code) };
            }

            async function updateISS() {
                try {
                    const response = await fetch('http://api.open-notify.org/iss-now.json');
                    if (!response.ok) throw new Error('ISS API failed');
                    const data = await response.json();

                    const lat = parseFloat(data.iss_position.latitude);
                    const lon = parseFloat(data.iss_position.longitude);
                    const time = new Date(data.timestamp * 1000);

                    issMarker.setLatLng([lat, lon]);
                    issPositions.push({ lat, lon, timestamp: data.timestamp });
                    while (issPositions.length > 0 && (data.timestamp - issPositions[0].timestamp) > 300) issPositions.shift();
                    if (issPositions.length > 50) issPositions.shift();
                    issPath.setLatLngs(issPositions.map(p => [p.lat, p.lon]));
                    map.panTo([lat, lon], { animate: true, duration: 1 });

                    const positionEl = document.getElementById('position');
                    if (positionEl) {
                        const { name, icon } = await getLocationWithIcon(lat, lon);
                        positionEl.classList.remove('data-value');
                        void positionEl.offsetWidth;
                        positionEl.classList.add('data-value');
                        positionEl.innerHTML = `${name} ${icon}`;
                        positionEl.classList.remove('glitch');
                    }

                    if (lastTimestamp && lastLat && lastLon) {
                        const dt = (data.timestamp - lastTimestamp) / 1000;
                        const dLat = lat - lastLat;
                        const dLon = lon - lastLon;
                        const distance = Math.sqrt(dLat * dLat + dLon * dLon) * 111;
                        const speed = distance / dt;
                        const altitude = 408;
                        document.getElementById('map-overlay').innerText = `ISS Speed: ${speed.toFixed(2)} km/s | Altitude: ${altitude} km`;
                    }

                    lastLat = lat;
                    lastLon = lon;
                    lastTimestamp = data.timestamp;

                    const video = document.getElementById('iss-video');
                    video.style.display = 'block';
                    setTimeout(() => video.style.display = 'none', 10000);
                } catch (error) {
                    console.error('ISS Fetch error:', error);
                    document.getElementById('position').innerHTML = '<span>Reconnecting...</span>';
                    document.getElementById('position').classList.add('glitch');
                    document.getElementById('map-overlay').innerText = 'ISS Speed: Offline | Altitude: Offline';
                }
            }

            function updateMarsSolDate() {
                const marsEpoch = new Date('1877-12-29T12:00:00Z').getTime();
                const now = Date.now();
                const marsSols = Math.floor((now - marsEpoch) / (1000 * 60 * 60 * 24 * 1.027));
                const solEl = document.getElementById('mars-sol-date');
                if (solEl) {
                    solEl.classList.remove('data-value');
                    void solEl.offsetWidth;
                    solEl.classList.add('data-value');
                    solEl.innerText = `Sol ${marsSols}`;
                }
            }

            function updateMarsWeather() {
                const widget = document.getElementById('mars-weather-widget');
                const tempSpan = document.getElementById('mars-weather');

                fetch(`https://api.nasa.gov/insight_weather/?api_key=${nasaApiKey}&feedtype=json&ver=1.0`)
                    .then(response => {
                        if (!response.ok) throw new Error('API unavailable');
                        return response.json();
                    })
                    .then(data => {
                        const sol = data.sol_keys[data.sol_keys.length - 1];
                        const temp = data[sol].AT.av;

                        if (tempSpan) {
                            tempSpan.classList.remove('data-value');
                            void tempSpan.offsetWidth;
                            tempSpan.classList.add('data-value');
                            tempSpan.textContent = `${temp.toFixed(1)}°C at Elysium Planitia`;
                        }
                        widget.classList.remove('cold', 'hot');
                        widget.classList.add(temp < -50 ? 'cold' : 'hot');
                    })
                    .catch(error => {
                        console.error('Mars Weather Fetch error:', error.message);
                        if (tempSpan) {
                            tempSpan.textContent = 'Offline';
                            tempSpan.classList.add('glitch');
                        }
                    });
            }

            function updateEarthMarsDistance() {
                const avgDistance = 225000000;
                const variation = Math.sin(Date.now() / (1000 * 60 * 60 * 24 * 365)) * 30000000;
                const distance = (avgDistance + variation).toFixed(0);
                const distanceEl = document.getElementById('earth-mars-distance');
                if (distanceEl) {
                    distanceEl.classList.remove('data-value');
                    void distanceEl.offsetWidth;
                    distanceEl.classList.add('data-value');
                    distanceEl.innerText = `${distance} km`;
                }
            }

            async function fetchMarsPhotos() {
                try {
                    const response = await fetch('https://mars-photos.herokuapp.com/api/v1/rovers/perseverance/latest_photos');
                    if (!response.ok) throw new Error('Mars Photos API failed');
                    const data = await response.json();
                    return data.latest_photos.slice(0, 10).map(photo => photo.img_src);
                } catch (error) {
                    console.error('Mars Photos Fetch error:', error.message);
                    return [
                        'https://www.nasa.gov/sites/default/files/thumbnails/image/pia21778-16.jpg',
                        'https://www.nasa.gov/sites/default/files/thumbnails/image/pia24836-1041.jpg',
                        'https://www.nasa.gov/sites/default/files/thumbnails/image/pia25407-1041.jpg'
                    ];
                }
            }

            async function updateMarsNews() {
                const realPhotos = await fetchMarsPhotos();
                let realMarsNews = [];
                let spaceNews = [];

                try {
                    const response = await fetch('https://mars-photos.herokuapp.com/api/v1/rovers/perseverance/latest_photos');
                    if (!response.ok) throw new Error('Mars Photos API failed');
                    const data = await response.json();
                    realMarsNews = data.latest_photos.slice(0, 10).map((photo, index) => ({
                        title: `Perseverance Rover Update #${index + 1}`,
                        description: `Latest image captured on Sol ${photo.sol} by ${photo.camera.full_name}.`,
                        publishedAt: photo.earth_date,
                        image: photo.img_src,
                        isFunny: false
                    }));
                } catch (error) {
                    console.error('Real Mars News Fetch error:', error.message);
                    realMarsNews = [
                        { title: "Mars Rovers Find Clues to Past Life", description: "NASA’s Perseverance made discoveries hinting at ancient microbial life.", publishedAt: "2025-04-01", image: realPhotos[0], isFunny: false },
                        { title: "Perseverance Spots Unusual Rock", description: "A mysterious rock formation puzzles scientists.", publishedAt: "2025-03-29", image: realPhotos[1], isFunny: false },
                        { title: "Curiosity Detects Organic Molecules", description: "Large organic molecules found in ancient sample.", publishedAt: "2025-03-25", image: realPhotos[2], isFunny: false }
                    ];
                }

                try {
                    const response = await fetch('https://api.spaceflightnewsapi.net/v4/articles/?limit=10');
                    if (!response.ok) throw new Error('Spaceflight News API failed');
                    const data = await response.json();
                    spaceNews = data.results.map((article, index) => ({
                        title: article.title,
                        description: article.summary,
                        publishedAt: article.published_at,
                        image: article.image_url || realPhotos[index % realPhotos.length],
                        isFunny: false
                    }));
                } catch (error) {
                    console.error('Space News Fetch error:', error.message);
                    spaceNews = [
                        { title: "SpaceX Launches Fram2 Mission", description: "First private crew orbits Earth’s poles.", publishedAt: "2025-04-01", image: realPhotos[0], isFunny: false },
                        { title: "NASA’s SPHEREx Telescope Sees First Light", description: "New infrared telescope begins cosmic mapping.", publishedAt: "2025-03-31", image: realPhotos[1], isFunny: false },
                        { title: "Airbus Joins Mars Life Search", description: "Replaces Russian agency in 2028 mission.", publishedAt: "2025-03-30", image: realPhotos[2], isFunny: false }
                    ];
                }

                const fakeNewsImages = [
                    'https://m.media-amazon.com/images/I/611mBMvRE+L._AC_UF894,1000_QL80_.jpg',
                    'https://npr.brightspotcdn.com/dims3/default/strip/false/crop/2928x1952+0+0/resize/1100/quality/50/format/jpeg/?url=http%3A%2F%2Fnpr-brightspot.s3.amazonaws.com%2F8e%2F05%2F2f0baf694255b2f686014778270d%2Fgettyimages-2194418432.jpg',
                    'https://assets.thehansindia.com/h-upload/2023/05/19/1352088-elon-musk.webp'
                ];
                const funnyNews = [
                    { title: "Elon Musk Claims Mars Has Best Wi-Fi", description: "Elon says Starlink on Mars beats Earth’s 5G: ‘Even aliens are jealous!’", publishedAt: "2025-04-04", image: fakeNewsImages[0], isFunny: true },
                    { title: "Elon’s Tesla Bot Caught Dancing on Mars", description: "Perseverance rover films Tesla Bot doing the moonwalk in low gravity.", publishedAt: "2025-04-03", image: fakeNewsImages[1], isFunny: true },
                    { title: "Musk Plans Mars BBQ with Alien Spices", description: "Elon announces first interplanetary cookout: ‘Martian dust adds flavor!’", publishedAt: "2025-04-02", image: fakeNewsImages[2], isFunny: true }
                ];

                const allNews = [...realMarsNews, ...spaceNews, ...funnyNews];

                function shuffleNews() {
                    const container = document.getElementById('mars-news-container');
                    container.innerHTML = '';
                    const shuffled = allNews.sort(() => 0.5 - Math.random()).slice(0, 3);

                    shuffled.forEach((article) => {
                        const newsItem = document.createElement('div');
                        newsItem.className = 'bg-gray-900/90 p-6 rounded-lg shadow-lg flex items-start space-x-4 border-l-4 border-orange-600';
                        newsItem.innerHTML = `
                            <img src="${article.image}" alt="${article.title}" class="w-40 h-40 md:w-48 md:h-48 rounded-md object-cover shadow-md border border-orange-800/50">
                            <div class="flex-1">
                                <h3 class="text-xl md:text-2xl font-semibold text-gray-200 tracking-tight">${article.title}${article.isFunny ? ' 😂' : ''}</h3>
                                <p class="mt-2 text-base md:text-lg text-gray-400 leading-relaxed">${article.description || 'No description available'}</p>
                                <p class="mt-2 text-sm md:text-base text-orange-400 font-mono">${new Date(article.publishedAt).toLocaleDateString()}</p>
                            </div>
                        `;
                        container.appendChild(newsItem);
                    });
                }

                shuffleNews();
                setInterval(shuffleNews, 60000);
            }

            const factText = document.getElementById('fact-text');
            const countdown = document.getElementById('countdown');
            const fallbackFacts = [
                "Mars has the largest volcano in the solar system, Olympus Mons, standing 22 km (13.6 mi) high.",
                "A day on Mars (a 'sol') is 24.6 hours, just 40 minutes longer than an Earth day.",
                "Mars’ red color comes from iron oxide (rust) on its surface."
            ];

            async function fetchSpaceFact() {
                try {
                    const response = await fetch('https://api.api-ninjas.com/v1/facts?limit=1', {
                        method: 'GET',
                        headers: {
                            'X-Api-Key': factsApiKey,
                            'Content-Type': 'application/json'
                        }
                    });
                    if (!response.ok) throw new Error(`Facts API failed: ${response.status}`);
                    const data = await response.json();
                    if (!data || !data[0]?.fact) throw new Error('Invalid response format');
                    let fact = data[0].fact;
                    if (!fact.toLowerCase().includes('space') && !fact.toLowerCase().includes('mars') &&
                        !fact.toLowerCase().includes('planet') && !fact.toLowerCase().includes('star')) {
                        fact = fallbackFacts[Math.floor(Math.random() * fallbackFacts.length)];
                    }
                    factText.textContent = `Did you know? ${fact}`;
                } catch (error) {
                    console.error('Fact Fetch error:', error.message);
                    factText.textContent = fallbackFacts[Math.floor(Math.random() * fallbackFacts.length)];
                }
            }

            function updateCountdown() {
                const now = new Date();
                const nextMidnight = new Date(now);
                nextMidnight.setHours(24, 0, 0, 0);
                const timeLeft = nextMidnight - now;
                const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                countdown.textContent = `Next Fact In: ${hours}h ${minutes}m ${seconds}s`;
            }

            const apodImage = document.getElementById('apod-image');
            const apodTitle = document.getElementById('apod-title');
            const apodExplanation = document.getElementById('apod-explanation');

            async function fetchAPOD() {
                const endDate = new Date().toISOString().split('T')[0];
                const startDate = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                let apodData = [];

                try {
                    const response = await fetch(`https://api.nasa.gov/planetary/apod?api_key=${nasaApiKey}&start_date=${startDate}&end_date=${endDate}`);
                    if (!response.ok) throw new Error('APOD API failed');
                    apodData = await response.json();
                    apodData = apodData.filter(item => item.media_type === 'image');
                    if (apodData.length === 0) throw new Error('No images available');
                } catch (error) {
                    console.error('APOD Fetch error:', error);
                    apodData = [{
                        url: 'https://apod.nasa.gov/apod/image/2102/MarsPerseveranceSol0.jpg',
                        title: 'Fallback: Mars Perseverance',
                        explanation: 'An image from Mars Perseverance rover, captured in 2021.',
                        media_type: 'image'
                    }];
                }

                function shuffleAPOD() {
                    const randomIndex = Math.floor(Math.random() * apodData.length);
                    const data = apodData[randomIndex];

                    const img = new Image();
                    img.src = data.url;
                    img.onload = () => {
                        apodImage.src = data.url;
                        apodImage.alt = data.title;
                        apodTitle.textContent = data.title;
                        apodExplanation.textContent = data.explanation.length > 100 ? `${data.explanation.substring(0, 100)}...` : data.explanation;
                    };
                    img.onerror = () => {
                        apodImage.src = 'https://apod.nasa.gov/apod/image/2102/MarsPerseveranceSol0.jpg';
                        apodImage.alt = 'Fallback: Mars Perseverance';
                        apodTitle.textContent = 'Fallback: Mars Perseverance';
                        apodExplanation.textContent = 'An image from Mars Perseverance rover, captured in 2021.';
                        console.error('Failed to load APOD image:', data.url);
                    };
                }

                shuffleAPOD();
                setInterval(shuffleAPOD, 60000);
            }

            const missionCountdownTimer = document.getElementById('mission-countdown-timer');
            function updateMissionCountdown() {
                const launchDate = new Date('2026-11-01T00:00:00Z');
                const now = new Date();
                const timeLeft = launchDate - now;
                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                missionCountdownTimer.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
            }

            fetchSpaceFact();
            updateCountdown();
            fetchAPOD();
            updateMarsNews();
            updateMissionCountdown();

            setInterval(updateCountdown, 1000);
            setInterval(fetchSpaceFact, 1000 * 60 * 60 * 24);
            setInterval(updateMissionCountdown, 1000);

            updateISS();
            updateMarsSolDate();
            updateMarsWeather();
            updateEarthMarsDistance();

            setInterval(updateISS, 10000);
            setInterval(updateMarsSolDate, 60000);
            setInterval(updateMarsWeather, 3600000);
            setInterval(updateEarthMarsDistance, 86400000);
            setInterval(() => {
                if (lastLat && lastLon) autoAdjustMap(lastLat, lastLon);
            }, 30000);
        });
    </script>
</body>
</html>
